<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Priority Power-Up: Bubble Pop</title>
  <style>
    html, body{
  width:100%;
  overflow-x:hidden;
}

    :root{
      --navy:#0B1F4D;
      --navy-dark:#081735;
      --magenta:#E6007E;
      --blue:#3C8DCC;
      --orange:#F5A623;
      --light-blue:#EAF2FA;
      --white:#ffffff;
      --muted:#5F6B8A;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 600px at 50% 20%, #1C4C8F 0%, var(--navy) 60%);
      color: var(--white);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .hidden{ display:none !important; }

    .screen{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 600px at 50% 20%, #1C4C8F 0%, var(--navy) 60%);
      padding:24px; z-index:1200;
    }
    .introCard{
      width:min(760px, 100%);
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.22);
      border-radius:22px;
      padding:34px;
      text-align:center;
      box-shadow: 0 25px 80px rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
    }
    .introSubtitle{
      margin:0 0 10px 0;
      font-size:12px;
      color: rgba(255,255,255,.85);
      letter-spacing:.9px;
      text-transform:uppercase;
      font-weight:900;
    }
    .introTitle{
      margin:0;
      font-size:34px;
      font-weight:950;
      letter-spacing:.4px;
    }
    .introTagline{
      margin:14px 0 20px 0;
      font-size:18px;
      font-weight:650;
      color: rgba(255,255,255,.92);
      line-height:1.25;
    }

    .panel{
      width:min(980px, 100%);
      background: var(--light-blue);
      border:1px solid rgba(11,31,77,.12);
      border-radius:18px;
      padding:18px;
      color: var(--navy);
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
    }
    .h{
      font-weight:950;
      margin:0 0 8px 0;
      font-size:22px;
      color: var(--navy);
    }
    .sub{
      margin:0 0 14px 0;
      color: var(--muted);
      font-size:14px;
      line-height:1.4;
      font-weight:700;
    }

    .hud{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:10px 0 12px 0;
    }
    .hudItem{
      flex:1 1 160px;
      background: rgba(255,255,255,.85);
      border:1px solid rgba(11,31,77,.10);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hudLabel{
      font-size:11px;
      font-weight:950;
      letter-spacing:.6px;
      text-transform:uppercase;
      color: rgba(11,31,77,.65);
    }
    .hudValue{
      font-size:14px;
      font-weight:950;
      color: var(--navy);
      white-space:nowrap;
    }

    .stage{
      position:relative;
      width:100%;
      height:440px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(11,31,77,.12);
      background: radial-gradient(900px 420px at 50% 20%, rgba(60,141,204,.20) 0%, rgba(11,31,77,.06) 55%, rgba(11,31,77,.02) 100%);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.35);
      touch-action: manipulation; /* tap-friendly */
    }
    @media (max-width: 620px){
      .stage{ height:400px; }
    }
    @media (max-width: 480px){
  .powerupStage{ height:320px; }
}
    #c{
      width:100%;
      height:100%;
      display:block;
    }

    .overlay{
      position:absolute; inset:0;
      display:flex;
      align-items:center; justify-content:center;
      padding:18px; text-align:center;
      font-weight:950;
      color: var(--navy);
      background: rgba(234,242,250,.80);
      backdrop-filter: blur(3px);
      border-radius:18px;
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
    }
    .overlay.show{ opacity:1; }

    .picked{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
      min-height:42px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(230,0,126,.10);
      border:2px solid var(--magenta);
      color: var(--navy);
      font-weight:950;
      font-size:13px;
    }
    .tag small{
      font-weight:900;
      color: rgba(11,31,77,.60);
    }

    .btnrow{
      display:flex;
      gap:12px;
      width:100%;
      max-width:520px;
      margin-top:10px;
    }
    button{
      flex:1;
      border:none;
      border-radius:12px;
      padding:12px 14px;
      font-weight:950;
      cursor:pointer;
      background: var(--magenta);
      border:1px solid rgba(255,255,255,.18);
      color: var(--white);
      box-shadow: 0 10px 24px rgba(230,0,126,.18);
    }
    button.secondary{
      background: var(--blue);
      box-shadow: 0 10px 24px rgba(60,141,204,.16);
    }
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    .msg{
      min-height:18px;
      margin-top:10px;
      color: rgba(11,31,77,.75);
      font-size:13px;
      font-weight:900;
    }
  </style>
</head>

<body>

  <!-- Intro -->
  <div id="intro" class="screen" role="dialog" aria-modal="true" aria-label="Intro">
    <div class="introCard">
      <div class="introSubtitle">Gratia Health presents</div>
      <h1 class="introTitle">Priority Power-Up</h1>
      <div class="introTagline">Tap bubbles to pop your top 3 workforce priorities.</div>
      <div style="margin-top:12px;">
        <button id="startBtn" type="button">Start</button>
      </div>
    </div>
  </div>

  <!-- Game -->
  <div id="app" class="hidden">
    <div class="panel">
      <h3 class="h">Priority Power-Up</h3>
      <p class="sub">
        Tap a bubble to <b>pop</b> it. Pick <b>3</b>. If you pop a 4th, it replaces your <b>most recent</b> pick.
      </p>

      <div class="hud">
        <div class="hudItem">
          <div class="hudLabel">Time</div>
          <div class="hudValue" id="timeLeft">25</div>
        </div>
        <div class="hudItem">
          <div class="hudLabel">Powered up</div>
          <div class="hudValue"><span id="poweredCount">0</span>/3</div>
        </div>
        <div class="hudItem">
          <div class="hudLabel">How to play</div>
          <div class="hudValue">Tap bubbles</div>
        </div>
      </div>

      <div class="stage" id="stage">
        <canvas id="c"></canvas>
        <div class="overlay show" id="overlay">Ready? Pop <b>3</b> priorities.</div>
      </div>

      <div class="picked" id="pickedWrap"></div>

      <div class="btnrow">
        <button class="secondary" id="resetBtn" type="button">Reset</button>
        <button id="continueBtn" type="button" disabled>Continue</button>
      </div>

      <div class="msg" id="msg"></div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const MAX = 3;
const TIMER_SEC = 25;

// 6 priorities only
const PRIORITIES = [
  { id:"px",        label:"Patient Experience", emoji:"‚ù§Ô∏è" },
  { id:"quality",   label:"Quality & Safety",   emoji:"üõ°Ô∏è" },
  { id:"retention", label:"Retention",          emoji:"üß≤" },
  { id:"onboarding",label:"Onboarding",         emoji:"üß≠" },
  { id:"culture",   label:"Team Culture",       emoji:"ü§ù" },
  { id:"staffing",  label:"Staffing Stability", emoji:"üìÖ" },
];

  let bag = [];

function refillBag(){
  bag = PRIORITIES.map(p=>p.id);
  for(let i=bag.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [bag[i], bag[j]] = [bag[j], bag[i]];
  }
}
function nextIdFromBag(){
  if(!bag.length) refillBag();
  return bag.pop();
}

function pickColor(id){
  const map = {
    retention: "rgba(230,0,126,.18)",
    px:        "rgba(60,141,204,.18)",
    quality:   "rgba(245,166,35,.18)",
    staffing:  "rgba(11,31,77,.12)",
    culture:   "rgba(230,0,126,.12)",
    onboarding:"rgba(60,141,204,.12)",
  };
  return map[id] || "rgba(11,31,77,.12)";
}

function labelFor(id){
  return (PRIORITIES.find(p=>p.id===id) || {}).label || id;
}

/* =========================
   DOM
========================= */
const intro = document.getElementById("intro");
const startBtn = document.getElementById("startBtn");
const app = document.getElementById("app");

const stage = document.getElementById("stage");
const canvas = document.getElementById("c");
const overlay = document.getElementById("overlay");

const timeLeftEl = document.getElementById("timeLeft");
const poweredCountEl = document.getElementById("poweredCount");
const pickedWrap = document.getElementById("pickedWrap");
const msgEl = document.getElementById("msg");
const resetBtn = document.getElementById("resetBtn");
const continueBtn = document.getElementById("continueBtn");

/* =========================
   STATE
========================= */
let ctx = null;
let DPR = 1;

let picked = [];   // keep max 3 (but replacement rule differs)
let bubbles = [];
let pops = [];     // explosion particles
let running = false;

let startAt = 0;
let lastAt = 0;
let raf = 0;

let nextSpawnAt = 0;
const SPAWN_EVERY_MS = 450;     // slower + spaced out
const MAX_ON_SCREEN = 6;        // keeps it manageable

/* =========================
   CANVAS
========================= */
function fitCanvas(){
  const rect = stage.getBoundingClientRect();
  DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  canvas.width  = Math.floor(rect.width * DPR);
  canvas.height = Math.floor(rect.height * DPR);
  canvas.style.width = rect.width + "px";
  canvas.style.height = rect.height + "px";
  ctx = canvas.getContext("2d");
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
function rand(a,b){ return a + Math.random()*(b-a); }

  function isSelected(id){
  return picked.includes(id);
}

function resetBubbleToTop(b, W){
  // keep it spread out horizontally
  b.x = rand(40, W - 40);
  b.y = -rand(30, 180);
}
/* =========================
   PICK LOGIC (your rule)
   - pick 1..3 fill
   - if pick 4th replaces LAST pick (slot 3)
========================= */
function renderPicked(){
  poweredCountEl.textContent = String(Math.min(picked.length, MAX));
  pickedWrap.innerHTML = "";

  picked.forEach((id, idx)=>{
    const tag = document.createElement("div");
    tag.className = "tag";
    const meta = (idx === picked.length-1) ? "last" : "";
    tag.innerHTML = `<span>${labelFor(id)}</span>${meta ? `<small>${meta}</small>` : ""}`;
    pickedWrap.appendChild(tag);
  });

  continueBtn.disabled = picked.length < MAX;
}

let completeTimer = null;
function showCompleteOverlay(){
  const lines = picked.slice(0,MAX).map(id=>`<li>${labelFor(id)}</li>`).join("");
  overlay.innerHTML = `
    <div>
      <div style="font-size:18px; font-weight:950; margin-bottom:8px;">Power-Up Complete</div>
      <div style="opacity:.85; margin-bottom:10px;">You powered up:</div>
      <ul style="margin:0; padding-left:18px; text-align:left;">${lines}</ul>
      <div style="margin-top:12px; font-size:12px; opacity:.8;">Tap <b>Continue</b> to move on.</div>
    </div>
  `;
  overlay.classList.add("show");

  if(completeTimer) clearTimeout(completeTimer);
  completeTimer = setTimeout(()=> overlay.classList.remove("show"), 1200);
}

function addPick(id){
  // ignore if already in list (optional: you can allow re-picking to ‚Äúrefresh‚Äù)
  if(picked.includes(id)) return;

  if(picked.length < MAX){
    picked.push(id);
  } else {
    // Replace LAST (most recent) pick
    picked[picked.length - 1] = id;
    msgEl.textContent = "Updated your priorities (replaced the last pick).";
    setTimeout(()=>{ msgEl.textContent = ""; }, 900);
  }

  renderPicked();

  if(picked.length === MAX){
    showCompleteOverlay();
  }
}

/* =========================
   BUBBLES
========================= */
function makeBubble(){
  const rect = stage.getBoundingClientRect();
  const id = nextIdFromBag();
const p = PRIORITIES.find(x => x.id === id);

  const r = rand(36, 48);   // bigger for iPhone
  const x = rand(r + 12, rect.width - r - 12);
  const y = -rand(80, 180);

  // slower fall
  const vy = rand(55, 80);
  // gentle drift
  const vx = rand(-10, 10);

  return {
    id: p.id,
    label: p.label,
    emoji: p.emoji,
    x, y, r, vx, vy,
  };
}

function spawnIfNeeded(now){
  if(now < nextSpawnAt) return;
  nextSpawnAt = now + SPAWN_EVERY_MS + rand(-60, 60);

  if(bubbles.length >= MAX_ON_SCREEN) return;

  // try not to spawn duplicates on screen too often
  const attempts = 4;
  for(let i=0;i<attempts;i++){
    const b = makeBubble();
    const exists = bubbles.some(x=>x.id===b.id);
    if(!exists || Math.random() < 0.35){
      bubbles.push(b);
      return;
    }
  }
  bubbles.push(makeBubble());
}

/* =========================
   POP / EXPLOSION
========================= */
function popBubble(b){
  // add pick
  addPick(b.id);

  // explosion particles
  const count = 18 + Math.floor(Math.random()*8);
  for(let i=0;i<count;i++){
    const ang = Math.random()*Math.PI*2;
    const sp = 70 + Math.random()*160;
    pops.push({
      x: b.x,
      y: b.y,
      vx: Math.cos(ang)*sp,
      vy: Math.sin(ang)*sp,
      r: 2 + Math.random()*4,
      life: 0,
      max: 0.35 + Math.random()*0.25,
      color: Math.random() < 0.5 ? "rgba(230,0,126,.95)" : "rgba(60,141,204,.95)"
    });
  }

  // remove bubble
  bubbles = bubbles.filter(x=>x !== b);
}

/* =========================
   HIT TEST
========================= */
function findBubbleAt(x,y){
  // topmost first
  for(let i=bubbles.length-1; i>=0; i--){
    const b = bubbles[i];
    const dx = x - b.x;
    const dy = y - b.y;
    if(Math.sqrt(dx*dx + dy*dy) <= b.r) return b;
  }
  return null;
}

/* =========================
   DRAW
========================= */
function draw(){
  const rect = stage.getBoundingClientRect();
  const W = rect.width, H = rect.height;

  ctx.clearRect(0,0,W,H);

  // subtle grid
  ctx.save();
  ctx.globalAlpha = 0.10;
  ctx.strokeStyle = "rgba(11,31,77,.35)";
  ctx.lineWidth = 1;
  const step = 46;
  for(let gx=0; gx<=W; gx+=step){
    ctx.beginPath(); ctx.moveTo(gx,0); ctx.lineTo(gx,H); ctx.stroke();
  }
  for(let gy=0; gy<=H; gy+=step){
    ctx.beginPath(); ctx.moveTo(0,gy); ctx.lineTo(W,gy); ctx.stroke();
  }
  ctx.restore();

  // bubbles
  bubbles.forEach(b=>{
    ctx.save();

    // bubble fill
    ctx.fillStyle = pickColor(b.id);
    ctx.strokeStyle = "rgba(11,31,77,.18)";
    ctx.lineWidth = 2;

    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();

    // highlight
    ctx.globalAlpha = 0.35;
    ctx.fillStyle = "rgba(255,255,255,.9)";
    ctx.beginPath();
    ctx.arc(b.x - b.r*0.35, b.y - b.r*0.35, b.r*0.28, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // emoji
    ctx.fillStyle = "rgba(11,31,77,.95)";
    ctx.font = "900 18px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(b.emoji, b.x, b.y - 10);

    // label
    ctx.font = "950 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(b.label, b.x, b.y + 14);

    ctx.restore();
  });

  // particles
  pops.forEach(p=>{
    ctx.save();
    ctx.fillStyle = p.color;
    ctx.globalAlpha = Math.max(0, 1 - (p.life / p.max));
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  });
}

/* =========================
   LOOP
========================= */
function tick(now){
  if(!running) return;

  if(!lastAt) lastAt = now;
  const dt = Math.min(0.033, (now - lastAt)/1000);
  lastAt = now;

  // timer
  const elapsed = (now - startAt)/1000;
  const timeLeft = Math.max(0, TIMER_SEC - elapsed);
  timeLeftEl.textContent = String(Math.ceil(timeLeft));

  // spawn slower + spaced
  spawnIfNeeded(now);

  // move bubbles
  const rect = stage.getBoundingClientRect();
  const W = rect.width, H = rect.height;

  bubbles.forEach(b=>{
    b.x += b.vx * dt;
    b.y += b.vy * dt;

    // gentle wall bounce
    if(b.x < b.r + 10){ b.x = b.r + 10; b.vx *= -1; }
    if(b.x > W - b.r - 10){ b.x = W - b.r - 10; b.vx *= -1; }
  });

  // clear bubbles that fall off
  bubbles = bubbles.filter(b=> b.y < H + 80);

  // particles update
  pops.forEach(p=>{
    p.vx *= 0.985;
    p.vy = p.vy*0.985 + 120*dt; // slight gravity
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.life += dt;
  });
  pops = pops.filter(p=> p.life < p.max);

  // time end
  if(timeLeft <= 0){
    running = false;
    overlay.innerHTML = (picked.length >= MAX)
      ? `Time‚Äôs up. Tap <b>Continue</b>.`
      : `Time‚Äôs up. Pop faster next time ‚Äî then tap <b>Reset</b>.`;
    overlay.classList.add("show");
    continueBtn.disabled = picked.length < MAX;
    draw();
    return;
  }

  draw();
  raf = requestAnimationFrame(tick);
}

function start(){
  fitCanvas();
  picked = [];
  bubbles = [];
  pops = [];
  renderPicked();

  // ‚úÖ ensure all 6 priorities cycle evenly
  bag = [];
  refillBag();

  msgEl.textContent = "Tap bubbles to pop your top 3 priorities.";
  overlay.innerHTML = "Ready? Pop <b>3</b> priorities.";
  overlay.classList.add("show");
  setTimeout(()=> overlay.classList.remove("show"), 800);

  running = true;
  startAt = performance.now();
  lastAt = 0;
  nextSpawnAt = performance.now() + 250;

  if(raf) cancelAnimationFrame(raf);
  raf = requestAnimationFrame(tick);
}

  msgEl.textContent = "Tap bubbles to pop your top 3 priorities.";
  overlay.innerHTML = "Ready? Pop <b>3</b> priorities.";
  overlay.classList.add("show");
  setTimeout(()=> overlay.classList.remove("show"), 800);

  running = true;
  startAt = performance.now();
  lastAt = 0;
  nextSpawnAt = performance.now() + 250;

  if(raf) cancelAnimationFrame(raf);
  raf = requestAnimationFrame(tick);
}

/* =========================
   INPUT (tap/click)
========================= */
function pointerToStageXY(e){
  const rect = stage.getBoundingClientRect();
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

// Click/tap to pop
stage.addEventListener("pointerdown", (e)=>{
  if(!running) return;
  const {x,y} = pointerToStageXY(e);
  const b = findBubbleAt(x,y);
  if(b){
    // prevent accidental scroll on mobile
    e.preventDefault();
    popBubble(b);
  }
}, { passive:false });

/* =========================
   BUTTONS / FLOW
========================= */
startBtn.addEventListener("click", ()=>{
  intro.classList.add("hidden");
  app.classList.remove("hidden");
  window.scrollTo(0,0);
  start();
});

resetBtn.addEventListener("click", ()=>{
  running = false;
  if(raf) cancelAnimationFrame(raf);
  start();
});

continueBtn.addEventListener("click", ()=>{
  // You can swap this for your Story/Results overlay
  overlay.innerHTML = `
    <div>
      <div style="font-size:18px; font-weight:950; margin-bottom:8px;">Power-Up Complete</div>
      <div style="opacity:.85; margin-bottom:10px;">You chose:</div>
      <div style="font-weight:950;">${picked.slice(0,MAX).map(labelFor).join(" ‚Ä¢ ")}</div>
      <div style="margin-top:12px; font-size:12px; opacity:.8;">(Hook this to your next screen.)</div>
    </div>
  `;
  overlay.classList.add("show");
});

window.addEventListener("resize", ()=>{
  if(!app.classList.contains("hidden")) fitCanvas();
});
</script>

</body>
</html>
